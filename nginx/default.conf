server {
    listen 80;
    server_name splitrx.kvinda.qzz.io;

    # Cloudflare sends X-Forwarded-Proto. If it's http, and we want to force https, we should redirect.
    # BUT if Cloudflare is in "Flexible" mode, it sends requests to us via HTTP.
    # If we redirect to HTTPS, the browser goes to HTTPS, Cloudflare accepts it, then sends HTTP to us again -> Loop.

    # Solution: 
    # 1. Trust Cloudflare headers
    set $proto $http_x_forwarded_proto;
    if ($proto = "") {
        set $proto $scheme;
    }

    # If the user came via HTTP (as reported by Cloudflare), redirect to HTTPS.
    # WAIT: In Flexible mode, User -> HTTPS -> CF -> HTTP -> Nginx.
    # So X-Forwarded-Proto is "https".
    # Nginx sees request on Port 80.
    # If we redirect: Nginx says "Go to https://...". Browser is already there. Refresh. Loop?
    # Actually, browser sees 301. It re-requests HTTPS. CF receives it. CF sends HTTP to Nginx. Loop.

    # To fix "Flexible" loop: we must serve content on port 80 if X-Forwarded-Proto is https.
    
    location /api/ {
        proxy_pass http://backend:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proto;
    }

    location / {
        proxy_pass http://frontend:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proto;
    }
}

server {
    listen 443 ssl;
    server_name splitrx.kvinda.qzz.io;

    # Self-signed certs (Cloudflare "Full" mode accepts these)
    ssl_certificate /etc/nginx/certs/self-signed.crt;
    ssl_certificate_key /etc/nginx/certs/self-signed.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Backend API Proxy
    location /api/ {
        proxy_pass http://backend:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend Proxy
    location / {
        proxy_pass http://frontend:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
